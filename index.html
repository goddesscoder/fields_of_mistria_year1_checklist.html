<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fields of Mistria — Year 1 Interactive Checklist</title>
  <style>
    :root{
      --bg:#0f1220;           /* dark, comfy */
      --card:#171a2b;
      --muted:#a5acc7;
      --text:#e9ecff;
      --accent:#c8a6ff;       /* pastel purple */
      --accent-2:#8be7d2;     /* pastel teal */
      --danger:#ff8aa8;       /* pastel pink/red */
      --ok:#9ee493;           /* soft green */
      --focus: 0 0 0 3px rgba(200,166,255,.45);
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% -10%, rgba(200,166,255,.12), transparent 60%),
                  radial-gradient(1000px 500px at 120% 10%, rgba(139,231,210,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter:saturate(120%) blur(10px);
      background: linear-gradient(180deg, rgba(15,18,32,.75), rgba(15,18,32,.55));
      border-bottom:1px solid rgba(200,166,255,.15);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:20px;}
    .title{display:flex; gap:14px; align-items:center; flex-wrap:wrap}
    .title h1{margin:0; font-size:clamp(20px, 3vw, 28px)}
    .title small{color:var(--muted)}
    .bar{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    button, .file-label{
      background:var(--card); border:1px solid rgba(200,166,255,.25); color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; box-shadow:var(--shadow);
      transition:.2s transform, .2s border-color, .2s background;
    }
    button:hover,.file-label:hover{transform:translateY(-1px); border-color:var(--accent)}
    button:focus-visible{outline:none; box-shadow:var(--focus)}
    button.accent{background:linear-gradient(90deg, rgba(200,166,255,.25), rgba(139,231,210,.18)); border-color:rgba(200,166,255,.45)}
    button.danger{border-color:rgba(255,138,168,.45)}
    .file-input{display:none}
    .search{flex:1; min-width:220px; display:flex; align-items:center; gap:8px; background:var(--card); padding:10px 12px; border-radius:12px; border:1px solid rgba(200,166,255,.25)}
    .search input{flex:1; background:transparent; border:none; color:var(--text); font-size:14px; outline:none}
    main{padding:22px 20px 48px}
    .grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:16px}
    details.season{background:var(--card); border:1px solid rgba(200,166,255,.22); border-radius:var(--radius); box-shadow:var(--shadow)}
    details[open]{border-color:rgba(200,166,255,.45)}
    summary{list-style:none; cursor:pointer; padding:16px 18px; display:flex; align-items:center; justify-content:space-between; gap:16px}
    summary::-webkit-details-marker{display:none}
    .season-title{display:flex; align-items:center; gap:10px}
    .season-title .dot{width:12px; height:12px; border-radius:999px; background:var(--accent); box-shadow:0 0 0 4px rgba(200,166,255,.18)}
    .progress{height:8px; background:#0c0f1b; border-radius:999px; overflow:hidden; border:1px solid rgba(200,166,255,.2)}
    .progress > span{display:block; height:100%; width:0; background:linear-gradient(90deg, var(--accent), var(--accent-2)); transition:width .25s ease}
    .content{padding:6px 16px 18px}
    .task{display:flex; align-items:flex-start; gap:12px; padding:10px 8px; border-radius:10px; border:1px solid transparent}
    .task:hover{background:rgba(200,166,255,.06); border-color:rgba(200,166,255,.12)}
    .task label{flex:1; cursor:pointer}
    input[type="checkbox"]{width:18px; height:18px; accent-color:var(--accent)}
    .muted{color:var(--muted)}
    .row{display:flex; gap:8px; align-items:center; margin:10px 0 0}
    .row input[type="text"]{flex:1; background:#121524; border:1px solid rgba(200,166,255,.25); color:var(--text); padding:10px 12px; border-radius:10px; outline:none}
    .row input[type="text"]:focus{box-shadow:var(--focus)}
    .chip{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid rgba(200,166,255,.25); color:var(--muted)}
    .actions{display:flex; gap:8px; align-items:center}
    .danger-link{color:var(--danger); background:transparent; border:1px dashed rgba(255,138,168,.45)}
    .kicker{color:var(--muted); margin:8px 0 0; font-size:13px}
    .count{font-variant-numeric:tabular-nums}
    mark{background: linear-gradient(90deg, rgba(200,166,255,.35), rgba(139,231,210,.25)); color:inherit; padding:0 .2em; border-radius:6px}

    @media print{
      header, .actions-global, .row, .kicker, .search {display:none !important}
      body{background:white; color:#111}
      details.season{break-inside:avoid; background:white; box-shadow:none; border:1px solid #ddd}
      input[type="checkbox"]{filter:grayscale(1)}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <h1>Fields of Mistria — Year 1 Interactive Checklist</h1>
        <small>Pastel, cozy, and persistent (saves to your browser).</small>
      </div>
      <div class="bar actions-global">
        <div class="search" role="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 21l-4.2-4.2M10.8 18a7.2 7.2 0 1 1 0-14.4 7.2 7.2 0 0 1 0 14.4Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          <input id="q" type="text" placeholder="Search tasks…" aria-label="Search tasks" />
        </div>
        <button id="expandAll" class="accent" title="Expand all">Expand all</button>
        <button id="collapseAll" title="Collapse all">Collapse all</button>
        <button id="print" title="Print / Save as PDF">Print / PDF</button>
        <button id="export" title="Export your progress">Export</button>
        <label class="file-label" for="importFile" title="Import a backup">Import<input id="importFile" class="file-input" type="file" accept="application/json" /></label>
        <button id="resetAll" class="danger" title="Reset everything">Reset all</button>
      </div>
      <p class="kicker">Tip: your progress auto-saves in <strong>this browser</strong> (localStorage). You can export/import to move between devices.</p>
    </div>
  </header>

  <main class="wrap">
    <div id="overall" style="margin:8px 0 18px">
      <div class="muted" style="display:flex; align-items:center; gap:10px; margin-bottom:8px">
        <span class="chip">Overall progress</span>
        <span class="count" id="overallCount">0 / 0</span>
      </div>
      <div class="progress"><span id="overallBar"></span></div>
    </div>

    <div class="grid" id="seasons"></div>
  </main>

<script>
(() => {
  const STORAGE_KEY = 'fom_year1_checklist_v1';
  const LAST_OPEN_KEY = 'fom_last_open_v1';

  const baseData = {
    'Spring (Days 1–28)': [
      'Complete opening quests (Greet the Townsfolk, etc.)',
      'Plant initial crops (tulips, turnips, etc.)',
      'Forage daily around the map',
      'Start doing requests at the request board',
      'Donate items to the museum when found',
      'Repair the broken bridge (gather wood + stone)',
      'Eat free soup at the Inn daily for stamina',
      'Talk to villagers daily (use map to track)',
      'Use leftover stamina for cooking/crafting'
    ],
    'Summer': [
      'Plant summer crops',
      'Focus on raising renown through quests & selling crops',
      'Enter mines when unlocked',
      'Dig for artifacts at dig spots',
      'Forage seasonal items',
      'Unlock first magical/essence perks',
      'Upgrade tools and bag',
      'Stockpile stone, wood, ore for building',
      'Donate new finds to museum'
    ],
    'Fall': [
      'Plant fall crops',
      'Forage mushrooms and seasonal flora',
      'Dive in rivers/ponds for underwater items',
      'Continue progressing deeper in mines',
      'Unlock mid-tier essence/magic abilities',
      'Start barn/coop upgrades if possible',
      'Track dig spots consistently',
      'Stock up resources for Winter',
      'Repair additional structures (beach bridge, etc.)'
    ],
    'Winter': [
      'Plant winter crops (if available)',
      'Spend more time mining and collecting artifacts',
      'Complete town upgrade quests (inn, mill, etc.)',
      'Unlock new areas (Deep Woods, etc.)',
      'Focus on museum donations & collection gaps',
      'Unlock/upgrade water sprite statue for auto-watering',
      'Refine farm layout for Year 2',
      'Save best seeds/propagations for Spring'
    ],
    'Ongoing Year 1 Habits': [
      'Check request board daily',
      'Eat free soup at the Inn',
      'Talk to villagers regularly for renown/quests',
      'Keep some wood, stone, ore in reserve',
      'Donate any museum-tagged items immediately',
      'Use stamina fully each day (crafting, cooking, mining, etc.)',
      'Learn monster attack patterns before fighting',
      'Sell repeatable high-yield crops for steady income'
    ]
  };

  // --- Storage helpers ---
  function load(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {checked:{}, custom:{}} }catch{ return {checked:{}, custom:{}} }
  }
  function save(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)) }

  function slugify(s){
    return s.toLowerCase().replace(/&/g,'and').replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-');
  }
  function taskId(season, text){ return slugify(season)+"::"+slugify(text) }

  // --- Render ---
  const seasonsEl = document.getElementById('seasons');
  const overallBar = document.getElementById('overallBar');
  const overallCount = document.getElementById('overallCount');

  let STATE = load();
  for (const s of Object.keys(baseData)) { if(!STATE.custom[s]) STATE.custom[s] = [] }

  function buildSeasonCard(season){
    const details = document.createElement('details');
    details.className = 'season';
    details.dataset.season = season;

    const sum = document.createElement('summary');
    const left = document.createElement('div'); left.className = 'season-title';
    const dot = document.createElement('span'); dot.className = 'dot'; left.appendChild(dot);
    const h2 = document.createElement('h2'); h2.style.margin = '0'; h2.style.fontSize = '18px'; h2.textContent = season; left.appendChild(h2);
    const count = document.createElement('span'); count.className = 'count muted'; count.id = `count-${slugify(season)}`; count.textContent = '0 / 0';
    sum.append(left, count);

    const content = document.createElement('div'); content.className = 'content';

    // progress
    const progressWrap = document.createElement('div'); progressWrap.style.margin = '0 0 10px';
    const progress = document.createElement('div'); progress.className = 'progress';
    const bar = document.createElement('span'); bar.id = `bar-${slugify(season)}`; progress.appendChild(bar);
    progressWrap.appendChild(progress);

    // list container
    const list = document.createElement('div'); list.className = 'list'; list.id = `list-${slugify(season)}`;

    // add task row
    const row = document.createElement('div'); row.className = 'row';
    const input = document.createElement('input'); input.type = 'text'; input.placeholder = `Add a ${season.split(' ')[0]} task…`;
    const addBtn = document.createElement('button'); addBtn.textContent = 'Add task'; addBtn.className = 'accent';
    addBtn.addEventListener('click', () => {
      const text = input.value.trim(); if(!text) return;
      const id = taskId(season, text + ' (custom)');
      STATE.custom[season].push({id, text});
      save(STATE); input.value='';
      renderListFor(season);
      updateProgress();
    });
    row.append(input, addBtn);

    // actions under list
    const actions = document.createElement('div'); actions.className = 'actions'; actions.style.marginTop = '8px';
    const resetBtn = document.createElement('button'); resetBtn.textContent = 'Reset this section'; resetBtn.className = 'danger-link';
    resetBtn.addEventListener('click', () => {
      // uncheck all in this section
      const ids = getTasksFor(season).map(t => t.id);
      ids.forEach(id => delete STATE.checked[id]);
      save(STATE); renderListFor(season); updateProgress();
    });
    const clearCustom = document.createElement('button'); clearCustom.textContent = 'Remove custom tasks'; clearCustom.className = 'danger-link';
    clearCustom.addEventListener('click', () => {
      if(!confirm('Remove all custom tasks in this section?')) return;
      STATE.custom[season] = [];
      save(STATE); renderListFor(season); updateProgress();
    });
    actions.append(resetBtn, clearCustom);

    content.append(progressWrap, list, row, actions);
    details.append(sum, content);
    return details;
  }

  function getTasksFor(season){
    const base = baseData[season].map(text => ({ id: taskId(season, text), text, base:true }));
    const custom = (STATE.custom[season]||[]).map(t => ({ id: t.id, text: t.text, custom:true }));
    return [...base, ...custom];
  }

  function renderListFor(season){
    const list = document.getElementById(`list-${slugify(season)}`);
    list.innerHTML = '';
    const query = (document.getElementById('q').value || '').toLowerCase().trim();
    const tasks = getTasksFor(season);

    for (const t of tasks){
      const wrap = document.createElement('div'); wrap.className = 'task';
      const cb = document.createElement('input'); cb.type = 'checkbox'; cb.id = t.id; cb.checked = !!STATE.checked[t.id];
      cb.addEventListener('change', () => { STATE.checked[t.id] = cb.checked || undefined; save(STATE); updateProgress(); })

      const label = document.createElement('label'); label.htmlFor = t.id;
      // highlight search term
      if(query && t.text.toLowerCase().includes(query)){
        const idx = t.text.toLowerCase().indexOf(query);
        label.innerHTML = `${t.text.slice(0,idx)}<mark>${t.text.slice(idx, idx+query.length)}</mark>${t.text.slice(idx+query.length)}`;
      } else label.textContent = t.text;

      const del = document.createElement('button'); del.textContent = '✕'; del.title = 'Remove task'; del.className='danger-link'; del.style.padding='4px 8px';
      del.addEventListener('click', () => {
        if(t.base) { alert('Base tasks can\'t be removed. You can uncheck or reset the section.'); return; }
        STATE.custom[season] = (STATE.custom[season] || []).filter(x => x.id !== t.id);
        delete STATE.checked[t.id];
        save(STATE); renderListFor(season); updateProgress();
      });

      wrap.append(cb,label,del);
      if(!query || t.text.toLowerCase().includes(query)) list.appendChild(wrap);
    }

    // empty state
    if(!list.children.length){
      const p = document.createElement('p'); p.className='muted'; p.textContent = query ? 'No matching tasks.' : 'No tasks yet.'; list.appendChild(p);
    }

    // update counts and bar
    const done = tasks.filter(t => STATE.checked[t.id]).length;
    const countEl = document.getElementById(`count-${slugify(season)}`);
    if(countEl) countEl.textContent = `${done} / ${tasks.length}`;
    const bar = document.getElementById(`bar-${slugify(season)}`);
    if(bar) bar.style.width = tasks.length ? `${Math.round((done / tasks.length) * 100)}%` : '0%';
  }

  function updateProgress(){
    let total = 0, done = 0;
    for (const season of Object.keys(baseData)){
      const tasks = getTasksFor(season);
      total += tasks.length;
      done += tasks.filter(t => STATE.checked[t.id]).length;
    }
    overallBar.style.width = total ? `${Math.round(done/total*100)}%` : '0%';
    overallCount.textContent = `${done} / ${total}`;
  }

  // Build UI
  seasonsEl.innerHTML = '';
  for (const season of Object.keys(baseData)){
    const card = buildSeasonCard(season);
    seasonsEl.appendChild(card);
  }

  // Restore last open panels
  const lastOpen = JSON.parse(localStorage.getItem(LAST_OPEN_KEY) || '[]');
  for(const el of document.querySelectorAll('details.season')){
    if(lastOpen.includes(el.dataset.season)) el.open = true;
    el.addEventListener('toggle', () => {
      const opens = Array.from(document.querySelectorAll('details.season')).filter(d => d.open).map(d => d.dataset.season);
      localStorage.setItem(LAST_OPEN_KEY, JSON.stringify(opens));
    });
  }

  // Initial render
  for (const season of Object.keys(baseData)) renderListFor(season);
  updateProgress();

  // Search
  document.getElementById('q').addEventListener('input', () => {
    for (const season of Object.keys(baseData)) renderListFor(season);
  });

  // Global actions
  document.getElementById('expandAll').addEventListener('click', () => {
    document.querySelectorAll('details.season').forEach(d => d.open = true);
    const opens = Object.keys(baseData); localStorage.setItem(LAST_OPEN_KEY, JSON.stringify(opens));
  });
  document.getElementById('collapseAll').addEventListener('click', () => {
    document.querySelectorAll('details.season').forEach(d => d.open = false);
    localStorage.setItem(LAST_OPEN_KEY, JSON.stringify([]));
  });
  document.getElementById('print').addEventListener('click', () => window.print());

  document.getElementById('export').addEventListener('click', () => {
    const blob = new Blob([ JSON.stringify(STATE, null, 2) ], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { href:url, download:'fields-of-mistria-year1-checklist-progress.json' });
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 500);
  });

  document.getElementById('importFile').addEventListener('change', e => {
    const file = e.target.files[0]; if(!file) return;
    const fr = new FileReader();
    fr.onload = () => {
      try {
        const data = JSON.parse(fr.result);
        if(!data || typeof data !== 'object') throw new Error('Invalid');
        // merge shape guards
        STATE = { checked: data.checked || {}, custom: data.custom || {} };
        for (const s of Object.keys(baseData)) if(!STATE.custom[s]) STATE.custom[s] = [];
        save(STATE);
        for (const season of Object.keys(baseData)) renderListFor(season);
        updateProgress();
        alert('Progress imported!');
      } catch(err){ alert('Import failed. Make sure you selected a valid backup JSON.'); }
    };
    fr.readAsText(file);
    e.target.value = '';
  });

  document.getElementById('resetAll').addEventListener('click', () => {
    if(!confirm('Reset ALL progress and remove all custom tasks?')) return;
    STATE = { checked:{}, custom:{} };
    for (const s of Object.keys(baseData)) STATE.custom[s] = [];
    save(STATE);
    for (const season of Object.keys(baseData)) renderListFor(season);
    updateProgress();
  });
})();
</script>
</body>
</html>

